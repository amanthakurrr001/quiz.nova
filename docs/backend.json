{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the QuizGenius application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "gmailId": {
          "type": "string",
          "description": "The user's Gmail address used for authentication.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "The user's first name."
        },
        "profession": {
          "type": "string",
          "description": "The user's profession (optional)."
        },
        "age": {
          "type": "number",
          "description": "The user's age (optional)."
        }
      },
      "required": [
        "id",
        "gmailId",
        "firstName"
      ]
    },
    "Quiz": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Quiz",
      "type": "object",
      "description": "Represents a quiz created by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the quiz."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who created the quiz. (Relationship: User 1:N Quiz)"
        },
        "title": {
          "type": "string",
          "description": "The title of the quiz."
        },
        "creationDate": {
          "type": "string",
          "description": "The date and time when the quiz was created.",
          "format": "date-time"
        },
        "isAiGenerated": {
          "type": "boolean",
          "description": "Indicates whether the quiz was generated by AI."
        },
        "quizData": {
          "type": "string",
          "description": "The quiz questions and answers in JSON format."
        }
      },
      "required": [
        "id",
        "userId",
        "title",
        "creationDate",
        "isAiGenerated",
        "quizData"
      ]
    },
    "QuizResult": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QuizResult",
      "type": "object",
      "description": "Represents the result of a user taking a quiz.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the quiz result."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who took the quiz. (Relationship: User 1:N QuizResult)"
        },
        "quizId": {
          "type": "string",
          "description": "Reference to the Quiz that was taken. (Relationship: Quiz 1:N QuizResult)"
        },
        "score": {
          "type": "number",
          "description": "The user's score on the quiz."
        },
        "completionDate": {
          "type": "string",
          "description": "The date and time when the quiz was completed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "quizId",
        "score",
        "completionDate"
      ]
    },
    "ApiKey": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ApiKey",
      "type": "object",
      "description": "Stores the Gemini API Key for each user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the API key entry."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who owns the API key. (Relationship: User 1:1 ApiKey)"
        },
        "apiKey": {
          "type": "string",
          "description": "The Gemini API Key."
        }
      },
      "required": [
        "id",
        "userId",
        "apiKey"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information, authenticated by Gmail. Includes personal details such as first name, profession, and age.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/quizzes/{quizId}",
        "definition": {
          "entityName": "Quiz",
          "schema": {
            "$ref": "#/backend/entities/Quiz"
          },
          "description": "Stores quizzes created by a specific user. Each quiz includes details such as title, creation date, AI generation status, and quiz data. Path-based ownership ensures only the user can access their quizzes.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user who created the quiz."
            },
            {
              "name": "quizId",
              "description": "The unique identifier for the quiz."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/quizResults/{quizResultId}",
        "definition": {
          "entityName": "QuizResult",
          "schema": {
            "$ref": "#/backend/entities/QuizResult"
          },
          "description": "Stores quiz results for a specific user. Each result includes the score and completion date. Path-based ownership ensures only the user can access their quiz results.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user who took the quiz."
            },
            {
              "name": "quizResultId",
              "description": "The unique identifier for the quiz result."
            }
          ]
        }
      },
      {
        "path": "/apiKeys/{apiKeyId}",
        "definition": {
          "entityName": "ApiKey",
          "schema": {
            "$ref": "#/backend/entities/ApiKey"
          },
          "description": "Stores API keys for individual users, allowing them to generate AI quizzes. Includes the API key and a reference to the user. ",
          "params": [
            {
              "name": "apiKeyId",
              "description": "The unique identifier for the API Key. It also includes the userId"
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the QuizGenius application, focusing on user authentication, quiz creation (both AI-generated and manual), and result tracking. The structure prioritizes Authorization Independence by avoiding hierarchical `get()` calls in security rules. Path-Based ownership is favored for private user data.\n\n**Authorization Independence:** The `/users/{userId}` path ensures that each user's data is isolated and controlled by their own `userId`. Subcollections like `/users/{userId}/quizzes` inherit this ownership, eliminating the need for complex `get()` calls to parent documents during authorization.\n\n**QAPs (Rules are not Filters):**\n\n*   **List Operation Security:** The structure facilitates secure `list` operations. For instance, listing quizzes under `/users/{userId}/quizzes` only returns quizzes created by that specific user, as enforced by security rules based on `request.auth.uid == userId`.\n\n*   **Segregation:** Different data types (user profiles, quizzes, results, API keys) are stored in separate collections, each with specific security rules. This segregation prevents unintended access or data leakage.\n\n*   **Ownership:** The structure enforces clear ownership. Users can only access and modify data under their own `userId` path, ensuring that they cannot tamper with other users' data.\n\n*   **Global Roles:** No global roles are used. All authorization is based on `request.auth.uid` and path-based ownership.\n\n**Invariants:**\n\n*   **Ownership:** Each quiz and quiz result is explicitly tied to a user via the `userId` field, maintaining ownership integrity.\n\n*   **Timestamps:** The `creationDate` and `completionDate` fields provide immutable timestamps for quizzes and results, supporting historical tracking and analysis.\n\n*   **Denormalized Data:** No denormalized data is strictly required in this design because path-based ownership is used. However, If a quiz needed to be shared outside a user's quizzes, the members field could be denormalized.\n\n**Guest User Handling:**\nGuest users can only generate and download quizzes. Since guest users only generate AI quizzes no guest profile is required, instead, the AI Quiz generation and download happen with a tempary quiz record that is generated and not saved to a user account. This approach eliminates any need to manage guest user data or profiles directly in the database. Guest users are anonymous users and all tempory quiz records are not persisted."
  }
}